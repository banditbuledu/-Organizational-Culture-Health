import streamlit as st
from google import genai
import plotly.graph_objects as go

# 1. AI μ—”μ§„ μ„¤μ • (Streamlit Secretsμ—μ„ μ—΄μ‡ λ¥Ό κ°€μ Έμµλ‹λ‹¤)
GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]
client = genai.Client(api_key=GOOGLE_API_KEY)

# 2. μ „λ¬Έκ°€μ 'μ§„λ‹¨ μ„¤λ…μ„' (μ΄κ²ƒμ΄ ν‚¤μ™€ ν΄μ„ ν•λ‚λ΅ ν•©μ³μ¤λ‹λ‹¤)
SYSTEM_INSTRUCTION = """
λ‹Ήμ‹ μ€ μ΅°μ§λ¬Έν™” μ „λ¬Έκ°€μ…λ‹λ‹¤. μ‚¬μ©μμ 20κ° λ¬Έν•­ μ‘λ‹µ(1~7μ )μ„ λ°”νƒ•μΌλ΅ 
'μ‹¬λ¦¬μ  μ•μ „κ°, ν–‰μ • ν¨μ¨μ„±, λ¦¬λ”μ‹­, μ •μ„μ  μΈμ •' 4κ° μμ—­μ„ λ¶„μ„ν•μ—¬ 
ν„μ¬ ν€μ μƒνƒμ™€ κ°μ„  λ°©μ•μ„ μ „λ¬Έμ μΌλ΅ μ μ‹ν•μ„Έμ”.
"""

st.set_page_config(page_title="μ΅°μ§λ¬Έν™” κ±΄κ°•λ„ μ§„λ‹¨", layout="wide")
st.title("π¥ μ΅°μ§λ¬Έν™” κ±΄κ°•λ„ μ§„λ‹¨ μ„λΉ„μ¤")
st.info("λ³Έ μ΅°μ‚¬λ” ν‰κ°€κ°€ μ•„λ‹ 'λ³€ν™”μ μ‹μ‘'μ„ μ„ν• λ°μ΄ν„°μ…λ‹λ‹¤.")

# 3. μ‚¬μ©μλ‹μ΄ μ£Όμ‹  20κ° λ¬Έν•­ (μ›λ³Έ λ‚΄μ© κ·Έλ€λ΅ μ΄μ‹)
questions = [
    "[μ‹¤μ ν¬μ©] μ—…λ¬΄ μ¤‘ μ°©μ¤λ‚ μ‹¤μκ°€ λ°μƒν–μ„ λ• μ‹μ¤ν… κ°μ„ μ— μ΄μ ", "[μ΄κ²¬ κ°μ§„] κ΄€λ¦¬μμ—κ² λ¶μ΄μµ μ—†μ΄ μμ λ΅­κ² μκ²¬ κ°μ§„",
    "[κ°λ“± ν•΄κ²°] κ°λ“± λ°μƒ μ‹ ν¬λ…ν•κ² λ…Όμν•κ³  μ΅°μ •", "[μƒνΈ μ΅΄μ¤‘] μ§κΈ‰/μ—°λ Ή μƒκ΄€μ—†μ΄ μ΅΄μ¤‘ν•λ” μ†ν†µ",
    "[μ¦‰κ°μ  λ³΄κ³ ] λ¬Έμ  λ°μƒ μ‹ μ¨κΈ°μ§€ μ•κ³  μ¦‰μ‹ κ³µμ ", "[κ΄€ν–‰ νƒ€ν] λ¶ν•„μ”ν• μμ „μ΄λ‚ λ³΄μ—¬μ£ΌκΈ°μ‹ ν–‰μ‚¬ μ¶•μ†",
    "[μ κ·Ή ν–‰μ •] κ·μ • ν•‘κ³„λ³΄λ‹¤ μ κ·Ήμ  ν•΄κ²° μ‹λ„ μ§€μ§€", "[λ¶€μ„ ν‘μ—…] λ¶€μ„ κ°„ κ²½κ³„λ¥Ό λ„μ–΄ μ μ—°ν•κ² ν‘λ ¥",
    "[μ—…λ¬΄ μ§‘μ¤‘] μ‹¤λ¬΄μκ°€ ν•µμ‹¬ μ—…λ¬΄μ— μ§‘μ¤‘ν•  μ μλ” ν™κ²½", "[νμ λ¬Έν™”] λ…ν™•ν• μ•κ±΄ μ¤‘μ‹¬μΌλ΅ μ§§κ² μ΄μ",
    "[λ¦¬λ”μ λ°©ν¨] μ™Έλ¶€ μ”κµ¬λ‚ μ•…μ„± λ―Όμ› μ‹ λ¦¬λ”κ°€ μ‹¤λ¬΄μ λ³΄νΈ", "[μ—…λ¬΄λ‰ μ΅°μ¨] μ—…λ¬΄κ°€ νΉμ •μΈμ—κ² λ°λ¦¬μ§€ μ•κ² ν•©λ¦¬μ  λ°°λ¶„",
    "[λ§¥λ½ κ³µμ ] μ—…λ¬΄ μ§€μ‹ μ‹ λ°°κ²½κ³Ό λ©μ μ„ λ‚©λ“ν•λ„λ΅ μ„¤λ…", "[μμ¨μ„± λ¶€μ—¬] μ‚¬μ†ν• κ°„μ„­ μ§€μ–‘ λ° μ‹¤λ¬΄μ μ¬λ‰ λ¶€μ—¬",
    "[μ„±μ¥ ν”Όλ“λ°±] μ§μ±…λ³΄λ‹¤ λ‹¤μλ²μ— λ” μν•  μ μλ„λ΅ λ€μ• μ΅°μ–Έ", "[μΌμƒμ  μΈμ •] λ™λ£λ¥Ό λ„μ™€μ¤€ μ§μ›μ„ μΌμƒμ μΌλ΅ μΉ­μ°¬",
    "[μ‹¤λ¬΄μ  νκ³ ] ν–‰μ‚¬ μΆ…λ£ ν›„ λ‹¨μν νμ‹μ΄ μ•„λ‹ κΈ°λ΅κ³Ό ν•™μµ", "[μ›λΌλ°Έ μ΅΄μ¤‘] μ •λ‹Ήν• ν΄κ°€ μ‚¬μ© μ‹ λμΉ μ£Όμ§€ μ•μ",
    "[μ„±μ¥ λ°°λ ¤] μ§λ¬΄ μ „λ¬Έμ„±μ„ μ„ν• κµμ΅ μ°Έμ—¬ λ°°λ ¤", "[λ…Έν•μ° κ³µμ ] μ—…λ¬΄ λ…Έν•μ°μ™€ μ„±κ³µ μ‚¬λ΅€λ¥Ό ν¬λ…ν•κ² κ³µμ "
]

# ν™”λ©΄ λ μ΄μ•„μ›ƒ μ„¤μ •
scores = []
cols = st.columns(2)
for i, q in enumerate(questions):
    with cols[i % 2]:
        score = st.select_slider(f"Q{i+1}. {q}", options=range(1, 8), value=4)
        scores.append(score)

# 4. κ²°κ³Ό ν™•μΈ λ²„νΌ ν΄λ¦­ μ‹ μ‹¤ν–‰
if st.button("π€ κ²°κ³Ό ν™•μΈ λ° AI μ‹¬μΈµ μ§„λ‹¨ μ‹μ‘"):
    # μμ—­λ³„ ν‰κ·  κ³„μ‚° (4λ€ μμ—­)
    avg_scores = [sum(scores[0:5])/5, sum(scores[5:10])/5, sum(scores[10:15])/5, sum(scores[15:20])/5]
    categories = ['μ‹¬λ¦¬μ  μ•μ „κ°', 'ν–‰μ • ν¨μ¨μ„±', 'λ¦¬λ”μ‹­', 'μ •μ„μ  μΈμ •']

    # λ μ΄λ” μ°¨νΈ (Plotly μ‚¬μ©)
    fig = go.Figure(data=go.Scatterpolar(
        r=avg_scores + [avg_scores[0]],
        theta=categories + [categories[0]],
        fill='toself',
        line_color='#5d5fef'
    ))
    fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[1, 7])))
    
    st.divider()
    c1, c2 = st.columns([1, 1])
    with c1:
        st.subheader("π“ μ΅°μ§ μ—­λ‰ λ¶„ν¬λ„")
        st.plotly_chart(fig, use_container_width=True)
    with c2:
        st.subheader("π’΅ AI μ „λ¬Έκ°€ μ§„λ‹¨ λ¦¬ν¬νΈ")
        with st.spinner("λ°μ΄ν„° λ¶„μ„ μ¤‘..."):
            response = client.models.generate_content(
                model="gemini-2.0-flash",
                config={'system_instruction': SYSTEM_INSTRUCTION},
                contents=f"μ μ λ°μ΄ν„°: {avg_scores}"
            )
            st.write(response.text)
